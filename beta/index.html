<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/MountainCircles---map/">
    <title>MountainCircles Map - Beta</title>
    <!-- Using jsDelivr instead of unpkg to avoid potential network errors on Windows -->
    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }
        /* Simple style for the basemap switcher */
        #styleSwitcher {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            background: #fff;
            padding: 5px;
            border-radius: 3px;
            font-family: sans-serif;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        /* Container uses flex, aligning items in the center vertically */
        #polygonOpacityControl {
            position: absolute;
            top: 50px;
            right: 10px;
            z-index: 1;
            background: #fff;
            padding: 5px;
            border-radius: 3px;
            font-family: sans-serif;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
        }
        /* Make the button a flex container so its content centers */
        #polygonOpacityControl button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-right: 5px;
            background: none;
            border: none;
            cursor: pointer;
            min-height: 24px; /* ensures the button is at least 24px tall */
        }
        /* Force the Material Icons font with !important */
        .material-icons-round {
            font-family: 'Material Icons Round' !important;
            font-size: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            color: #000;
        }
        /* Dark mode adjustments */
        @media (prefers-color-scheme: dark) {
            .material-icons-round {
                color: #fff;
            }
        }

        /* --------------- MAP DOCK (apple-dock style) --------------- */
        #mapDock {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            flex-direction: column;
            gap: 10px;
            z-index: 1100;
        }

        /* -------------------------- */
        /* Slider Container (Dock Box) */
        /* -------------------------- */
        .dock-slider {
            width: 48px;       /* Same as other button width */
            height: 150px;     /* Give enough room for the rotated slider */
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.8); /* Light mode: white-ish background */
            border-radius: 8px;
            padding: 8px;
            box-sizing: border-box;
        }

        /* Slider styling remains the same in landscape mode */
        #polygonOpacitySlider {
            width: 150px;  /* Length of the slider track */
            -webkit-transform: rotate(-90deg);
            -ms-transform: rotate(-90deg);
            transform: rotate(-90deg);
            -webkit-appearance: none; /* Remove default styling */
            background: transparent;  /* Needed for custom pseudo-elements */
        }

        /* Portrait mode: dock is horizontal, so the slider must be horizontal */
        @media (orientation: portrait) {
            #mapDock {
                position: fixed;
                top: 10px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            .dock-slider {
                /* Adjust container to have the same height as other buttons */
                width: 150px;
                height: 48px;
                background: rgba(255, 255, 255, 0.8);
                border-radius: 8px;
                padding: 8px;
                box-sizing: border-box;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            /* Force the slider to be horizontal by resetting its rotation */
            .dock-slider #polygonOpacitySlider {
                -webkit-transform: rotate(0deg) !important;
                -ms-transform: rotate(0deg) !important;
                transform: rotate(0deg) !important;
                width: 100% !important;
            }
        }

        /* Dark mode adjustments: use a grey background similar to the buttons */
        @media (prefers-color-scheme: dark) {
            .dock-slider {
                background: rgba(20, 20, 20, 0.8);
            }
        }

        /* ===================== */
        /* Custom Slider Styling */
        /* ===================== */

        /* For Webkit Browsers (Chrome, Safari, Opera) */
        #polygonOpacitySlider::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #ccc;
            border-radius: 3px;
        }
        #polygonOpacitySlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #fff;
            margin-top: -7px; /* Center the thumb on the track */
            cursor: pointer;
        }

        /* For Firefox */
        #polygonOpacitySlider::-moz-range-track {
            width: 100%;
            height: 6px;
            background: #ccc;
            border-radius: 3px;
        }
        #polygonOpacitySlider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
        }

        /* For IE */
        #polygonOpacitySlider::-ms-track {
            width: 100%;
            height: 6px;
            background: transparent;
            border-color: transparent;
            color: transparent;
        }
        #polygonOpacitySlider::-ms-fill-lower {
            background: #ccc;
            border-radius: 3px;
        }
        #polygonOpacitySlider::-ms-fill-upper {
            background: #ccc;
            border-radius: 3px;
        }
        #polygonOpacitySlider::-ms-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
        }

        /* Dark mode adjustments: use a darker grey for the slider track */
        @media (prefers-color-scheme: dark) {
            #polygonOpacitySlider::-webkit-slider-runnable-track {
                background: #555;
            }
            #polygonOpacitySlider::-moz-range-track {
                background: #555;
            }
            #polygonOpacitySlider::-ms-fill-lower,
            #polygonOpacitySlider::-ms-fill-upper {
                background: #555;
            }
        }

        #mapDock button {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            outline: none;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease;
            /* Ensure each button has enough room for the icon */
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #mapDock button:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 1);
        }
        #mapDock .material-icons-round {
            font-family: 'Material Icons Round';
            font-size: 24px;
            line-height: 24px;
            color: #000;
        }
        @media (prefers-color-scheme: dark) {
            #mapDock button {
                background: rgba(20, 20, 20, 0.8);
            }
            #mapDock button:hover {
                background: rgba(20, 20, 20, 1);
            }
            #mapDock .material-icons-round {
                color: #fff;
            }
        }

        /* --------------- POPUP MENU (centered on screen) --------------- */
        #popupMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1200;
        }
        #popupMenu .popup-content {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            position: relative;
            font-family: sans-serif;
        }
        #popupMenu .close {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            font-size: 20px;
            font-family: 'Material Icons Round';
        }
        @media (prefers-color-scheme: dark) {
            #popupMenu .popup-content {
                background: #333;
                color: #fff;
            }
        }

        /* Style for the IGC file control within the popup */
        #popupMenu button#igcFileButton {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            background: #eee;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-family: sans-serif;
        }
        #popupMenu button#igcFileButton:hover {
            background: #ddd;
        }
        #popupMenu button#igcFileButton .material-icons-round {
            font-family: 'Material Icons Round';
            font-size: 20px;
        }
    </style>
</head>
<body>
    <!-- Transparent Loading/Connection Message on Top of the Map -->
    <div id="loadingMessage" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255,255,255,0.8); padding: 10px 20px; border-radius: 3px; font-family: sans-serif; display: none;">
        Loading files, please wait...
    </div>

    <div id="map"></div>

    <!-- Transparent Box on Bottom Left with Big Bold Text -->
    <div id="parametersBox" style="position: absolute; bottom: 10px; left: 10px; z-index: 1; background: rgba(255, 255, 255, 0.5); padding: 10px; border-radius: 5px; font-family: sans-serif; font-weight: bold; font-size: 24px; color: #000;">
        L/D 20 - ground 100m - circuit 250m
    </div>

    <!-- Map Dock: Controls always visible -->
    <div id="mapDock">
        <!-- Toggle Button -->
        <button title="Toggle Layer Visibility" id="toggleLayerButton">
            <span class="material-icons-round" id="visibilityIcon">visibility</span>
        </button>
        
        <!-- Slider wrapper for polygon opacity -->
        <div class="dock-slider">
            <input id="polygonOpacitySlider" type="range" min="0" max="0.5" step="0.01" value="0.1">
        </div>
        
        <!-- Other dock buttons -->
        <button title="Increase Text Size" id="textIncreaseBtn">
            <span class="material-icons-round">exposure_plus_1</span>
        </button>
        <button title="Decrease Text Size" id="textDecreaseBtn">
            <span class="material-icons-round">exposure_minus_1</span>
        </button>
        <button title="More Options" id="moreOptionsBtn">
            <span class="material-icons-round">menu</span>
        </button>
    </div>

    <!-- Popup Menu: For controls not requiring constant map visibility -->
    <div id="popupMenu">
        <div class="popup-content">
            <span class="close" id="closePopupBtn">&times;</span>
            <h2>Other Options</h2>
            <p>Here you can add extra controls or settings.</p>
            <!-- IGC File Control with Icon -->
            <button id="igcFileButton">
                <span class="material-icons-round">folder_open</span>
                <span>Open IGC File</span>
            </button>
            <!-- Hidden file input triggered by the IGC file button -->
            <input type="file" id="igcFileInput" accept=".igc" style="display: none;">
        </div>
    </div>

    <script>
        // Added new custom style. Ensure that your extracted tiles are placed in a folder "tiles"
        // at the root of your repository.
        const customStyle = {
            "version": 8,
            "name": "Custom Map",
            "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
            "sources": {
                "custom-tiles": {
                    "type": "raster",
                    "tiles": [
                        "./tiles/{z}/{x}/{y}.png"  // Relative path to your tiles folder on GitHub Pages
                    ],
                    "tileSize": 256,
                    "attribution": "Map data Â© Your Attribution"
                }
            },
            "layers": [
                {
                    "id": "custom-tiles",
                    "type": "raster",
                    "source": "custom-tiles",
                    "minzoom": 0,
                    "maxzoom": 22
                }
            ]
        };

        // Update the styles object to include only the custom style.
        const styles = {
            custom: customStyle  // Only custom style remains.
        };

        // Set the default style
        let currentStyle = customStyle;

        // Function to show the loading message with a given text.
        function showLoadingMessage(text) {
            const messageDiv = document.getElementById('loadingMessage');
            messageDiv.textContent = text;
            messageDiv.style.display = "block";
        }

        // Function to hide the loading message.
        function hideLoadingMessage() {
            document.getElementById('loadingMessage').style.display = "none";
        }

        // --- Connection Message Logic ---
        function updateConnectionMessage() {
            const messageDiv = document.getElementById('loadingMessage');
            if (!navigator.onLine) {
                messageDiv.textContent = "No internet connection. Please connect to the internet.";
                messageDiv.style.display = "block";
            } else {
                messageDiv.style.display = "none";
            }
        }

        updateConnectionMessage();

        window.addEventListener('offline', updateConnectionMessage);
        window.addEventListener('online', updateConnectionMessage);

        const map = new maplibregl.Map({
            container: 'map',
            style: currentStyle,
            bounds: [[4.9698169, 43.6088902], [13.696105, 47.5644488]],
            fitBoundsOptions: {
                padding: 50,
                maxZoom: 14,
                duration: 1000
            }
        });

        function addGeoJSONLayers() {
            if (!map.getSource('geojson-data')) {
                map.addSource('geojson-data', {
                    type: 'geojson',
                    data: 'aa_alps_20-100-250.geojson'
                });
            }
            
            if (!map.getLayer('linestrings-layer')) {
                map.addLayer({
                    id: 'linestrings-layer',
                    type: 'line',
                    source: 'geojson-data',
                    filter: ['==', '$type', 'LineString'],
                    paint: {
                        'line-color': '#000',
                        'line-width': ['step', ['zoom'], 1, 10, 2]
                    }
                });
            }
            
            if (!map.getLayer('linestrings-labels')) {
                map.addLayer({
                    id: 'linestrings-labels',
                    type: 'symbol',
                    source: 'geojson-data',
                    minzoom: 8,
                    filter: ['==', '$type', 'LineString'],
                    layout: {
                        'text-field': '{ELEV}',
                        'symbol-placement': 'line',
                        'text-rotation-alignment': 'auto',
                        'text-keep-upright': true,
                        'text-size': 14,
                        'text-allow-overlap': false,
                        'text-ignore-placement': false,
                        'text-offset': [0, 0],
                        'symbol-spacing': 250
                    },
                    paint: {
                        'text-color': '#000',
                        'text-halo-color': '#fff',
                        'text-halo-width': 2
                    }
                });
            }

            if (!map.getLayer('points-layer')) {
                map.addLayer({
                    id: 'points-layer',
                    type: 'circle',
                    source: 'geojson-data',
                    filter: ['==', '$type', 'Point'],
                    paint: {
                        'circle-radius': 10,
                        'circle-color': '#ff0000',
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#fff'
                    }
                });
            }

            if (!map.getLayer('points-labels')) {
                map.addLayer({
                    id: 'points-labels',
                    type: 'symbol',
                    source: 'geojson-data',
                    minzoom: 7,
                    filter: ['==', '$type', 'Point'],
                    layout: {
                        'text-field': '{name}',
                        'text-size': 17,
                        'text-allow-overlap': false,
                        'text-ignore-placement': true,
                        'text-offset': [0.8, 0.8]
                    },
                    paint: {
                        'text-color': '#000',
                        'text-halo-color': '#fff',
                        'text-halo-width': 2
                    }
                });
            }

            if (!map.getSource('polygons')) {
                map.addSource('polygons', {
                    type: 'geojson',
                    data: 'aa_alps_20-100-250_sectors1.geojson'
                });
            }
            
            if (!map.getLayer('polygons-layer')) {
                map.addLayer({
                    id: 'polygons-layer',
                    type: 'fill',
                    source: 'polygons',
                    paint: {
                        'fill-color': [
                            "match",
                            ["get", "color_id"],
                            0, "#0000FF",
                            1, "#FF00FF",
                            2, "#FFFF00",
                            3, "#00FFFF",
                            4, "#00FF00",
                            5, "#FF0000",
                            6, "#FFA500",
                            "#000000"
                        ],
                        'fill-opacity': 0.1
                    }
                });
            }
            
            if (map.getLayer('linestrings-labels')) {
                map.moveLayer('linestrings-labels');
            }
            if (map.getLayer('points-labels')) {
                map.moveLayer('points-labels');
            }

            if (!map.getLayer('points-layer-clickable')) {
                map.addLayer({
                    id: 'points-layer-clickable',
                    type: 'circle',
                    source: 'geojson-data',
                    filter: ['==', '$type', 'Point'],
                    paint: {
                        'circle-radius': 20,
                        'circle-color': '#000000',
                        'circle-opacity': 0
                    }
                });
            }

            if (map.getLayer('points-layer-clickable')) {
                map.moveLayer('points-layer-clickable');
            }
            if (map.getLayer('points-layer')) {
                map.moveLayer('points-layer');
            }
            if (map.getLayer('points-labels')) {
                map.moveLayer('points-labels');
            }
        }

        function handlePointClick(e) {
            console.log("Point clicked event:", e);
            if (!e.features || !e.features.length) return;

            const feature = e.features[0];
            if (!feature.properties || !feature.properties.filename) {
                console.warn("Clicked feature missing 'filename' property:", feature);
                return;
            }
            const pointFileName = feature.properties.filename;
            const dynamicLayerId = 'dynamic-lines-' + pointFileName;
            const dynamicSourceId = dynamicLayerId + '-source';
            const dynamicLabelId = dynamicLayerId + '-labels';

            if (map.getLayer(dynamicLayerId)) {
                console.log("Removing dynamic layer:", dynamicLayerId);
                if (map.getLayer(dynamicLayerId)) map.removeLayer(dynamicLayerId);
                if (map.getLayer(dynamicLabelId)) map.removeLayer(dynamicLabelId);
                if (map.getSource(dynamicSourceId)) map.removeSource(dynamicSourceId);
            } else {
                console.log("Adding dynamic layer for:", pointFileName);
                map.addSource(dynamicSourceId, {
                    type: 'geojson',
                    data: pointFileName
                });
                
                map.addLayer({
                    id: dynamicLayerId,
                    type: 'line',
                    source: dynamicSourceId,
                    filter: ['==', '$type', 'LineString'],
                    paint: {
                        'line-color': '#000',
                        'line-width': ['step', ['zoom'], 1, 10, 2]
                    }
                });
                
                map.addLayer({
                    id: dynamicLabelId,
                    type: 'symbol',
                    source: dynamicSourceId,
                    minzoom: 8,
                    filter: ['==', '$type', 'LineString'],
                    layout: {
                        'text-field': '{ELEV}',
                        'symbol-placement': 'line',
                        'text-rotation-alignment': 'auto',
                        'text-keep-upright': true,
                        'text-size': 14,
                        'text-allow-overlap': false,
                        'text-ignore-placement': false,
                        'text-offset': [0, 0],
                        'symbol-spacing': 250
                    },
                    paint: {
                        'text-color': '#000',
                        'text-halo-color': '#fff',
                        'text-halo-width': 2
                    }
                });
            }
        }

        map.on('load', () => {
            addGeoJSONLayers();
            if (map.getLayer('points-layer-clickable')) {
                map.on('click', 'points-layer-clickable', handlePointClick);
            } else {
                console.warn("points-layer-clickable not found on map load.");
            }
            if (navigator.onLine) {
                map.once('idle', hideLoadingMessage);
            }
        });

        map.on('styledata', () => {
            addGeoJSONLayers();
            map.off('click', 'points-layer-clickable', handlePointClick);
            if (map.getLayer('points-layer-clickable')) {
                map.on('click', 'points-layer-clickable', handlePointClick);
            } else {
                console.warn("points-layer-clickable not found during styledata event.");
            }
        });

        map.on('error', (e) => {
            console.error('Map error:', e);
        });

        const polygonOpacitySlider = document.getElementById('polygonOpacitySlider');
        polygonOpacitySlider.addEventListener('input', function() {
            const opacity = parseFloat(this.value);
            if (map.getLayer('polygons-layer')) {
                map.setPaintProperty('polygons-layer', 'fill-opacity', opacity);
            }
        });

        // Global variables for text size of label layers 
        // (adjust these initial values to match your map's initial label sizes)
        let currentPointsLabelSize = 17;
        let currentLinesLabelSize = 14;

        // Increase text size by 1 for both label layers
        document.getElementById('textIncreaseBtn').addEventListener('click', () => {
            currentPointsLabelSize++;
            currentLinesLabelSize++;
            if (map.getLayer('points-labels')) {
                map.setLayoutProperty('points-labels', 'text-size', currentPointsLabelSize);
            }
            if (map.getLayer('linestrings-labels')) {
                map.setLayoutProperty('linestrings-labels', 'text-size', currentLinesLabelSize);
            }
        });

        // Decrease text size by 1 for both label layers (with a minimum value check)
        document.getElementById('textDecreaseBtn').addEventListener('click', () => {
            currentPointsLabelSize = Math.max(1, currentPointsLabelSize - 1);
            currentLinesLabelSize = Math.max(1, currentLinesLabelSize - 1);
            if (map.getLayer('points-labels')) {
                map.setLayoutProperty('points-labels', 'text-size', currentPointsLabelSize);
            }
            if (map.getLayer('linestrings-labels')) {
                map.setLayoutProperty('linestrings-labels', 'text-size', currentLinesLabelSize);
            }
        });

        // Toggle the popup menu
        const popupMenu = document.getElementById('popupMenu');
        document.getElementById('moreOptionsBtn').addEventListener('click', () => {
            popupMenu.style.display = "flex";
        });
        document.getElementById('closePopupBtn').addEventListener('click', () => {
            popupMenu.style.display = "none";
        });

        // Close popup when clicking outside the popup content
        popupMenu.addEventListener('click', (e) => {
            if(e.target === popupMenu) {
                popupMenu.style.display = "none";
            }
        });

        // Trigger file input when Open IGC File button is clicked
        document.getElementById('igcFileButton').addEventListener('click', function() {
            document.getElementById('igcFileInput').click();
        });

        // Handle file selection (place your file processing logic here)
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            console.log("Selected file", file);
        }
        document.getElementById('igcFileInput').addEventListener('change', handleFileSelect);

        // Toggle layer visibility using the "toggleLayerButton" (replicates checkbox functionality from index.html)
        document.getElementById('toggleLayerButton').addEventListener('click', () => {
            const layerIds = ['linestrings-layer', 'linestrings-labels', 'polygons-layer'];
            // Determine the new visibility: use one of the layer's current visibility as a basis.
            let newVisibility = 'visible';
            if (map.getLayer('linestrings-layer')) {
                const currentVisibility = map.getLayoutProperty('linestrings-layer', 'visibility') || 'visible';
                newVisibility = currentVisibility === 'visible' ? 'none' : 'visible';
            }
            // Set the new visibility on each layer
            layerIds.forEach(id => {
                if (map.getLayer(id)) {
                    map.setLayoutProperty(id, 'visibility', newVisibility);
                }
            });
            // Update the icon to reflect the current state.
            document.getElementById('visibilityIcon').textContent = newVisibility === 'visible' ? 'visibility' : 'visibility_off';
        });
    </script>
</body>
</html>